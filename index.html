<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Digital Welcome Gift</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; }
        .gold-gradient { background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-6 text-white">

    <div class="w-full max-w-sm bg-zinc-900 border border-zinc-800 rounded-[2rem] p-8 text-center shadow-2xl">
        <h2 class="text-zinc-400 text-xs uppercase tracking-widest mb-2">Exclusive Access</h2>
        <h1 class="gold-gradient text-4xl font-black italic mb-6">50% OFF</h1>
        
        <div id="couponCode" class="bg-black/40 border border-zinc-700 rounded-xl p-4 mb-8 font-mono text-2xl tracking-widest cursor-pointer">
            WELCOME50
        </div>

        <button id="installBtn" class="w-full bg-white text-black font-bold py-4 rounded-2xl mb-3">
            Save to My Phone
        </button>
        
        <button id="shopBtn" class="w-full bg-zinc-800 text-white font-bold py-4 rounded-2xl">
            Shop Now
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

        // --- PASTE YOUR FIREBASE KEYS BELOW ---
        const firebaseConfig = {
            apiKey: "AIzaSyCdmxqyvuz2RNYe_HWRceg3JiJkH0c03TY",
            authDomain: "passta-85c7a.firebaseapp.com",
            projectId: "passta-85c7a",
            storageBucket: "passta-85c7a.firebasestorage.app",
            messagingSenderId: "690886140069",
            appId: "1:690886140069:web:13048793908361ad19ad4c",
            measurementId: "G-TPRQP5CKTM"
        };
        const VAPID_KEY = "BDZW5LIUsZcbZN8HUq7TE-7narmXfpBohJKQQ9R7RH-espBWqK8CpyxheUKqo2a5OWTtxKjY0JhnEDRvD2ZQcO8";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const messaging = getMessaging(app);

        let deferredPrompt;

        // Analytics
        const logAction = async (name) => {
            try { await addDoc(collection(db, "analytics"), { event: name, time: serverTimestamp() }); } catch(e) {}
        };

        // PWA Setup
        window.addEventListener('beforeinstallprompt', (e) => { 
            e.preventDefault(); 
            deferredPrompt = e; 
        });

        // THE FIXED BUTTON LOGIC
        document.getElementById('installBtn').addEventListener('click', async () => {
            console.log("Button clicked...");

            // 1. Ask for Notification Permission
            const permission = await Notification.requestPermission();
            
            if (permission === 'granted') {
                try {
                    // 2. Register Service Worker with the correct GitHub subfolder path
                    const registration = await navigator.serviceWorker.register('firebase-messaging-sw.js', {
                        scope: '/Passta/'
                    });

                    // 3. WAIT for the worker to be ready (The Fix!)
                    const activeWorker = await navigator.serviceWorker.ready;
                    console.log("Worker Ready");

                    // 4. Get the Notification Token
                    const token = await getToken(messaging, { 
                        vapidKey: VAPID_KEY,
                        serviceWorkerRegistration: activeWorker
                    });

                    if (token) {
                        await setDoc(doc(db, "subscribers", token), { token: token, date: serverTimestamp() });
                        alert("Pass Saved! Look out for reminders.");
                        logAction("Save_Successful");
                    }

                    // 5. Try to trigger the Install Prompt (Android Only)
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                    }
                } catch (err) {
                    console.error("Error:", err);
                    alert("Click again in 2 seconds (Still activating...)");
                }
            } else {
                alert("Please enable notifications to save the pass.");
            }
        });

        document.getElementById('shopBtn').addEventListener('click', () => {
            logAction("Shop_Now_Click");
            window.location.href = "https://www.thebrandwebsite.com";
        });
    </script>
</body>
</html>
